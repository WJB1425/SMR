# SMR website: https://yanglab.westlake.edu.cn/software/smr/#Overview

# mQTL: QTL data for exploratory analysis (PMID:29599431): 
# https://molgenis26.gcc.rug.nl/downloads/eqtlgen/cis-eqtl/2019-12-11-cis-eQTLsFDR-ProbeLevel-CohortInfoRemoved-BonferroniAdded.txt.gz
# eQTL: QTL data for exploratory analysis (PMID:34475573): 
# https://yanglab.westlake.edu.cn/data/SMR/LBC_BSGS_meta.tar.gz
# pQTL: QTL data for exploratory analysis (PMID:34648354): 
# https://www.synapse.org/Synapse:syn51761394/files/

############### GWAS Data Processing Requirements:
# GWAS data must strictly contain the following columns in this exact order: 
# SNP, A1, A2, freq, b, se, p, and n.
# "A1" must be the effect allele, "A2" the other allele, and "freq" the frequency of "A1".
# Please note: The "n" column is not used for SMR or HEIDI analysis, 
# so it can be replaced with "NA" if not available.
# Allele frequency information in the "freq" column will be used in QC steps 
# to remove SNPs with inconsistent allele frequencies between datasets.

## GWAS data can be processed directly using linux commands. The following is a processing example:
# Source text column names:
# CHR, SNP, BP, A1, A2, FRQ_A_59851, FRQ_U_113154, INFO, OR, SE, P, ngt, Direction, HetISqt, HetDf, HetPVa, Nca, NcNeff
## FRQ_A_59851 and FRQ_U_113154 are the effect allele (A1) frequencies measured in case and control samples, respectively. 
## They are similar, so either one can be chosen.
## If the total sample effect allele frequency (A1) is available, use the total frequency.

# Step 1: Extract specific columns
awk -F'\t' 'BEGIN {OFS="\t"} {print $2, $4, $5, $6, $9, $10, $11,$17, $18}' [GWAS_INPUT_FILE] > extracted_columns.tsv

# Step 2: Calculate N and B (Beta/Effect Size)
awk -F'\t' 'BEGIN {OFS="\t"} 
    FNR == 1 {print $1, $2, $3, $4, "B", $6, $7, "N"}
    FNR > 1 {print $1, $2, $3, $4, log($5), $6, $7, $8+$9}' extracted_columns.tsv > [PROCESSED_GWAS_FILE].txt

## Alternatively, process the data using R language code, as shown below:
# For [COHORT_NAME] data:
dat <- fread('./[INPUT_FILE_NAME]',header = T,na.strings = "",data.table = F)
view(head(dat))
dat <- dat %>% 
  filter(!rsids == 'NA') %>% 
  # Separate rows where the rsids column contains comma-separated SNPs
  separate_rows(rsids, sep = ',')
colnames(dat)
dat <- dat %>% 
  select('rsids','alt','ref','af_alt','beta','sebeta','pval') %>% 
  set_names('SNP','A1','A2','freq','b','se','p') %>% 
  mutate(n = [N_CALCULATION_HERE]) # Placeholder for N calculation
view(head(dat))  
fwrite(dat, file = './[PROCESSED_GWAS_FILE].txt',
       quote = F,sep = '\t',row.names = F)


############################## SMR Analysis Command:

#[SMR_SOFTWARE_PATH]/smr is the location of the SMR software
--bfile # This parameter does not need modification
--gwas-summary # This parameter takes the processed GWAS data from above
--beqtl-summary # This parameter takes the mQTL, eQTL, or pQTL data (large files, requires downloading)
--out # This parameter specifies the output file name (no suffix needed; output will be .msmr and other files)
# Other parameters do not require modification

# Step 1: Gene methylation level as exposure, disease as outcome (GWAS-mQTL SMR analysis)
[SMR_SOFTWARE_PATH]/smr \
--bfile [REFERENCE_GENOME_PATH]/g1000_eur \
--gwas-summary [YOUR_DIR]/your_gwas_summary.txt \
--beqtl-summary mqtl_data \
--out [YOUR_DIR]/your_gwas_summary_mqtl \
--thread-num 10 \
--diff-freq 0.2 \
--diff-freq-prop 0.05 \
--smr-multi

# Step 2: Gene expression level as exposure, disease as outcome (GWAS-eQTL SMR analysis)
[SMR_SOFTWARE_PATH]/smr \
--bfile [REFERENCE_GENOME_PATH]/g1000_eur \
--gwas-summary [YOUR_DIR]/your_gwas_summary.txt \
--beqtl-summary eqtl_data \
--out [YOUR_DIR]/your_gwas_summary_eqtl \
--thread-num 10 \
--diff-freq 0.2 \
--diff-freq-prop 0.05 \
--smr-multi

# Step 3: Gene protein expression level as exposure, disease as outcome (GWAS-pQTL SMR analysis)
[SMR_SOFTWARE_PATH]/smr \
--bfile [REFERENCE_GENOME_PATH]/g1000_eur \
--gwas-summary [YOUR_DIR]/your_gwas_summary.txt \
--beqtl-summary pqtl_data \
--out [YOUR_DIR]/your_gwas_summary_pqtl \
--thread-num 10 \
--diff-freq 0.2 \
--diff-freq-prop 0.05 \
--smr-multi

############################## SMR Analysis Result Processing:
# The .msmr output files generated by the above commands require the following steps:

# 1. Apply FDR correction to the P-values: Example code: eqtl$FDR <- p.adjust(p = eqtl$p_SMR, method = 'BH')
# 2. Filter for genes included in the pre-defined gene set: The SMR result file includes all genes from the QTL data. We need to filter for the genes of interest (from the gene set specified in the project report).

# mQTL result filtering: The mQTL result file does not contain a gene name column. The 'probeID' column is the methylation site name. Gene names must be matched using the '[MQTL_META_FILE].txt' file in the '[MQTL_META_FOLDER]' folder before filtering.

# eQTL result filtering: In the eQTL result file, the 'probeID' and 'Gene' columns use ENSEMBL IDs (starting with ENSG). Since the target gene set is often in SYMBOL ID (e.g., RAF), these names must be converted to ENSEMBL IDs for filtering, using the following code:
# Install R packages
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("clusterProfiler")

if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("org.Hs.eg.db")

library(clusterProfiler)
library(org.Hs.eg.db)
gene_ENSEMBL<-bitr(gene_SYMBOL,
             fromType="SYMBOL",
             toType=c('ENTREZID','ENSEMBL'),
             OrgDb = "org.Hs.eg.db")

# pQTL result filtering: The 'probeID' column in the pQTL result file contains SYMBOL IDs, allowing direct filtering. The 'Gene' column is the corresponding protein name.

# 3. Decision on P-value threshold: The filtered QTL result files now contain 'FDR' and 'p_SMR_multi' P-value columns. The analysis goal is to identify genes that are significant (p < 0.05) across all three QTL results (mQTL, eQTL, pQTL), or at least in mQTL and eQTL. Therefore, the choice between the 'FDR' column or the 'p_SMR_multi' column depends on which one best achieves this goal.

# Furthermore, when selecting positive genes based on the chosen P-value column, it is crucial to ensure that the P-value in the 'pHEIDI' column is > 0.05 (or > 0.01).

############################## Colocalization Analysis
# Objective of Colocalization Analysis: For significant GWAS signals (p < 5e-08), the goal is to explain how these loci affect the disease, specifically whether they influence the disease by impacting gene methylation, expression, or protein expression.
# Colocalization analysis can provide this explanation. When a GWAS signal and an xQTL signal are found to colocalize, it suggests that the GWAS locus may affect the disease by altering the gene's biological process.

# Data used for colocalization analysis:
# mqtl: mQTLs_coloc.txt
# eqtl: eQTLs_coloc.txt
# pqtl: pQTLs_coloc.txt
# Specific code implementation is in the R code files.


############################## Downstream Analysis Based on SMR Results:
# m-e SMR analysis results can be extracted from existing files: mqtl_eqtl.msmr
# eQTL-pQTL SMR results can be extracted from existing files: eqtl_mqtl.msmr

############################## SMR Result Visualization: (Latest journal recommendation: results should be presented as jpeg, png, or tiff; resolution can be adjusted via the 'res' parameter in the corresponding function, e.g., res = 300)
## For genes significant (p < 0.05) in mQTL and eQTL (and optionally pQTL), use SMREffectPlot and SMRLocusPlot to display the results for that gene.

# 1. First, generate the plotting data using SMR:
# --beqtl-summary # This parameter takes the mQTL, eQTL, or pQTL data under the [QTL_DATA_PATH] path
# --gwas-summary [QTL_DATA_PATH] # This parameter takes the processed GWAS data from above
# --probe # Input the single 'probeID' of the gene significant (p < 0.05) in mQTL and eQTL (and optionally pQTL)
# --out # This parameter specifies the output file name; the file name will be suffixed with the probeID name, so this parameter does not need modification

[SMR_SOFTWARE_PATH]/smr \
--bfile [REFERENCE_GENOME_PATH]/g1000_eur \
--gwas-summary [YOUR_DIR]/your_gwas_summary.txt \
--beqtl-summary [QTL_DATA_PATH]/ \
--plot \
--probe probeID \
--out plot \
--probe-wind 500 \
--gene-list [REFERENCE_GENE_LIST_PATH]/glist-hg19.txt \
--thread-num 10

# 2. Plotting in R language:

source("[COMMON_R_SCRIPT_PATH]/plot_SMR_refine.r") 

# plot.probeID.txt is the output file from the --out parameter above
SMRData = ReadSMRData("plot.probeID.txt") # Read data

# Take mQTL as an example: Add the gene name (SYMBOL) corresponding to the methylation site ProbeID
probe = data.table::fread('[MQTL_META_FILE_PATH]')
head(probe$Closest_TSS_gene_name[match(SMRData$SMR$V1,probe$ID)])
SMRData$SMR$V4 <- probe$Closest_TSS_gene_name[match(SMRData$SMR$V1,probe$ID)]

# Replace the P-value in SMRData based on the filtering standard (using p_SMR_multi as an example here)
SMRData$SMR$V8 <- GWAS_mQTL$p_SMR_multi[match(SMRData$SMR$V1,GWAS_mQTL$probeID)] # GWAS_mQTL is the SMR result for mQTL

# Take m-e analysis result as an example: Extract the methylation site probe IDs (probeid.list) for the gene to be displayed
eQTL_mQTL_pass_multi <- data.table::fread('[YOUR_DIR]/smr_mqtl_eqtl.txt') # This data should be filtered beforehand
probeid.list <- eQTL_mQTL_pass_multi$Expo_ID[which(eQTL_mQTL_pass_multi$SYMBOL == "Your_SYMBOL")]


## SMRLocusPlot plotting (modify parameters as below)
SMRLocusPlot(data=SMRData, ## Original parameter, input data
             smr_thresh=0.05, ## Original parameter, P-value threshold standard
             heidi_thresh=0.05, ## Original parameter, HEIDI test threshold standard
             plotWindow=500,  ## Original parameter, display window size
             max_anno_probe=15, ## Original parameter, maximum number of probes to annotate
             smr_thresh_type = "p_SMR_multi", ## Updated parameter, threshold type label
             smrindx = probeid.list) ## Updated parameter, target highligh probes

SMREffectPlot(data=SMRData, 
              trait_name=paste0("Effect Plot for ","Your_SYMBOL"), ## Main title (can be modified or omitted)
              title1 = "mQTLs", ## Axis title (modify according to data type)
              title2 = "GWAS", ## Axis title (generally not modified)
              Pval_title = "p_SMR_multi") ## Updated parameter, criterion type

### Forest plot showing results significant (p < 0.05) in mQTL, eQTL, and pQTL
# dat1 is the result file filtered after SMR analysis
dat1 <- read.table('[QTL_SIGNIFICANT_RESULTS].txt') # dat1: Table of significant SMR results. If mQTL results are too long, select results supported by colocalization. If the colocalization-supported forest plot is still longer than one page, select the final conclusive methylation sites for the forest plot.
label <- cbind(c("probeID", dat1$probeID), 
               c("Gene", dat1$SYMBOL), # Note: Use the column for protein names for pQTL data
               c("OR (95%CI)",paste0(dat1$OR_SMR,'(',dat1$CI_SMR,')')), # OR and 95% CI
               c("Pvalue",round(dat1$p_SMR,5)),
               c("FDR",round(dat1$fdr_SMR,5)), # Use FDR or multi_pvalue
               c("PPH4",dat1$PPH4))
library(forestplot)
forestplot(labeltext = label, # Set columns for text display
           mean = c(NA,dat1$OR_SMR), # Set mean values (OR values)
           lower = c(NA,dat1$CI_SMR_lower), # Set lower limit of OR CI
           upper = c(NA,dat1$CI_SMR_upper), # Set upper limit of OR CI
           zero = 1, # Set reference value (1 for OR)
           boxsize = 0.2, # Set the size of the point estimate square
           # lineheight = unit(4,'mm'), # Set line height in the graph
           # colgap = unit(15,'mm'), # Set column spacing in the graph
           lwd.zero = 2, # Set reference line thickness
           lwd.ci = 2, # Set CI line thickness
           col=fpColors(box='black',lines = 'black',zero = 'grey'),
           # Use fpColors() to define colors for graphical elements: point estimate box, summary value, CI line, and reference line (left to right)
           hrzl_lines = list("1" = gpar(lty=1,lwd=1,col="black"),
                             "2" = gpar(lty=1,lwd=1,col="black")), # Add black horizontal lines above the first and second rows
           lwd.xaxis=2, # Set X-axis line thickness
           lty.ci = "solid", # Line shape
           graph.pos = 3, # Set forest plot position (here set to column 3)
           clip=c(0,3), # Arrows
           xticks = c(0,1,2), # Tick marks
           txt_gp=fpTxtGp(label=gpar(fontfamily="serif",cex=1), # Set font and size
                          ticks=gpar(fontfamily="serif",cex=1), 
                          xlab=gpar(fontfamily="serif",cex=0.8), 
                          title=gpar(fontfamily="serif",cex=1))
) %>% 
  fp_set_zebra_style("#EFEFEF")


### Manhattan plot showing the final filtered results significant in mQTL, eQTL, and pQTL (corresponding to highlight_names)

## New Manhattan plot source
source("[COMMON_R_SCRIPT_PATH]/refine_manh.R") 

## Specify highlight points: The intersection of mQTL, eQTL, and pQTL results is currently considered the optimal result. If there is no three-way intersection, focus on the cross-results filtered by (mQTL-GWAS, eQTL-GWAS, mQTL-eQTL) as the primary focus for highlighting.

eqtl <- fread('smr_eQTLs_eQTLGen_*.txt')
mqtl <- fread('smr_mQTLs_LBC_BSGS_meta_*.txt')
pqtl <- fread('smr_pQTLs_[P_QTL_STUDY_ID]_*.txt') # pQTL data comes in 3 types; use the one actually utilized

gene <- intersect(intersect(eqtl$SYMBOL,mqtl$SYMBOL),pqtl$probeID) 
highlight_names <- mqtl$probeID[mqtl$SYMBOL %in% gene]

## Input data includes the corresponding Symbol (for display), probeID, chromosome position information, and the selected P-value standard (FDR or p_SMR_multi)
gwas <- dat[,c('SYMBOL','probeID','ProbeChr','Probe_bp','p_SMR_multi')]
# dat is the .msmr result file obtained from SMR analysis

## Plotting: Use Manhattan_refine() directly; parameters can generally remain unchanged
Manhattan_refine(Background_data = gwas, ## Input data
                 highlight_names = highlight_names, ## Key results to highlight
                 thresholds_line_color = "#E58601", ## Threshold line color
                 points_color = "#A5C2A3", ## Background point color
                 highlight_color = "#972D15", ## Highlight point color
                 pointsize = 1.5, ## Background point size
                 highlight_size = 2, ## Highlight point size
                 label_size = 3.5, ## Label size
                 force=0.2, ## Label repulsion force
                 pval_names = "p_SMR_multi", ## Threshold type label
                 thresholds = 0.05, ## Threshold standard
                 legend_position=c(0.9,0.8),
                 legend_labels = "SMR: cis-mQTL Plasma") ## Legend content (modify for different QTLs)

## mQTL, eQTL, pQTL color schemes (for reference)

# mQTL: thresholds_line_color = "#E58601", ## Threshold line color
#                 points_color = "#A5C2A3", ## Background point color
#                 highlight_color = "#972D15", ## Highlight point color

# eQTL: thresholds_line_color = "#E58601", ## Threshold line color
#                 points_color = "#B0AFA2", ## Background point color
#                 highlight_color = "#046C9A", ## Highlight point color

# pQTL: thresholds_line_color = "#E58601", ## Threshold line color
#                 points_color = "#C6CDF7", ## Background point color
#                 highlight_color = "#02401B", ## Highlight point color
